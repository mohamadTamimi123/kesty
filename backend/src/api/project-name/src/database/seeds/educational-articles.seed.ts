import { DataSource, IsNull } from 'typeorm';
import { EducationalArticle } from '../../educational-articles/entities/educational-article.entity';
import { Category } from '../../categories/entities/category.entity';
import { User, UserRole } from '../../users/entities/user.entity';

// Helper function to generate slug
function generateSlug(text: string): string {
  return text
    .toLowerCase()
    .trim()
    .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFFa-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-+|-+$/g, '');
}

// Helper function to generate unique slug
async function generateUniqueSlug(
  repository: any,
  baseSlug: string,
): Promise<string> {
  let slug = baseSlug;
  let counter = 1;

  while (true) {
    const existing = await repository.findOne({
      where: { slug },
    });

    if (!existing) {
      return slug;
    }

    slug = `${baseSlug}-${counter}`;
    counter++;
  }
}

const articleTitles = [
  'راهنمای کامل ماشینکاری CNC: از اصول تا پیشرفته',
  'فرزکاری CNC: تکنیک‌ها و نکات کاربردی',
  'تراشکاری CNC: انتخاب ابزار و پارامترهای برش',
  'برش لیزری فلزات: مزایا و کاربردها',
  'برش پلاسما: اصول و تکنیک‌های پیشرفته',
  'خمکاری ورق فلز: روش‌ها و محاسبات',
  'جوشکاری TIG: تکنیک‌های حرفه‌ای',
  'جوشکاری MIG/MAG: راهنمای جامع',
  'پرداخت سطح فلزات: روش‌های مختلف',
  'آندایزینگ آلومینیوم: فرآیند و کاربردها',
  'چاپ سه‌بعدی فلزات: تکنولوژی‌های روز',
  'قالب‌سازی تزریقی: طراحی و ساخت',
  'ریخته‌گری: انواع روش‌ها و کاربردها',
  'پولیش و پرداخت سطح: تکنیک‌های حرفه‌ای',
  'سنگ‌زنی: انتخاب چرخ سنگ و پارامترها',
  'ماشینکاری با دقت بالا: تکنیک‌های پیشرفته',
  'کنترل کیفیت در تولید: روش‌های بازرسی',
  'بهینه‌سازی فرآیند تولید: کاهش ضایعات',
  'نگهداری و تعمیرات ماشین‌آلات: راهنمای جامع',
  'انتخاب متریال مناسب: راهنمای کامل',
];

const articleContents = [
  `<h2>مقدمه</h2>
<p>ماشینکاری CNC یکی از پیشرفته‌ترین روش‌های تولید در صنعت است که دقت و سرعت بالایی را فراهم می‌کند. در این مقاله به بررسی اصول اولیه و تکنیک‌های پیشرفته ماشینکاری CNC می‌پردازیم.</p>

<h2>اصول اولیه CNC</h2>
<p>ماشینکاری CNC (Computer Numerical Control) به معنای کنترل عددی کامپیوتری است. این تکنولوژی امکان تولید قطعات پیچیده با دقت بالا را فراهم می‌کند.</p>

<h3>مزایای ماشینکاری CNC</h3>
<ul>
  <li>دقت بالا در تولید</li>
  <li>سرعت تولید مناسب</li>
  <li>قابلیت تکرارپذیری</li>
  <li>کاهش ضایعات</li>
</ul>

<h2>نکات مهم</h2>
<p>برای دستیابی به بهترین نتیجه در ماشینکاری CNC، باید به پارامترهای برش، انتخاب ابزار و برنامه‌نویسی دقیق توجه کرد.</p>`,

  `<h2>فرزکاری CNC چیست؟</h2>
<p>فرزکاری یکی از رایج‌ترین روش‌های ماشینکاری است که در آن ابزار برش چرخان برای حذف مواد از قطعه کار استفاده می‌شود.</p>

<h2>انواع فرزکاری</h2>
<ul>
  <li>فرزکاری رو به بالا (Climb Milling)</li>
  <li>فرزکاری رو به پایین (Conventional Milling)</li>
  <li>فرزکاری سه محوره</li>
  <li>فرزکاری پنج محوره</li>
</ul>

<h2>انتخاب ابزار</h2>
<p>انتخاب ابزار مناسب برای فرزکاری به عوامل مختلفی مانند جنس قطعه کار، عمق برش و سرعت برش بستگی دارد.</p>`,

  `<h2>تراشکاری CNC</h2>
<p>تراشکاری یکی از قدیمی‌ترین و رایج‌ترین روش‌های ماشینکاری است که برای تولید قطعات استوانه‌ای استفاده می‌شود.</p>

<h2>پارامترهای مهم</h2>
<ul>
  <li>سرعت برش (Cutting Speed)</li>
  <li>عمق برش (Depth of Cut)</li>
  <li>نرخ پیشروی (Feed Rate)</li>
</ul>

<h2>نکات کاربردی</h2>
<p>برای دستیابی به بهترین نتیجه در تراشکاری، باید به انتخاب ابزار، تنظیمات ماشین و برنامه‌نویسی دقیق توجه کرد.</p>`,

  `<h2>برش لیزری فلزات</h2>
<p>برش لیزری یکی از روش‌های مدرن برش فلزات است که دقت و سرعت بالایی دارد.</p>

<h2>مزایا</h2>
<ul>
  <li>دقت بالا</li>
  <li>سرعت برش مناسب</li>
  <li>کاهش ضایعات</li>
  <li>قابلیت برش اشکال پیچیده</li>
</ul>

<h2>کاربردها</h2>
<p>برش لیزری در صنایع مختلف از جمله خودروسازی، هوافضا و ساخت و ساز کاربرد دارد.</p>`,

  `<h2>برش پلاسما</h2>
<p>برش پلاسما روشی است که از جریان پلاسما برای برش فلزات استفاده می‌کند.</p>

<h2>اصول کار</h2>
<p>در این روش، گاز تحت فشار به قوس الکتریکی تبدیل شده و پلاسما ایجاد می‌کند که قادر به برش فلزات است.</p>

<h2>مزایا</h2>
<ul>
  <li>سرعت بالا</li>
  <li>قابلیت برش فلزات ضخیم</li>
  <li>هزینه مناسب</li>
</ul>`,

  `<h2>خمکاری ورق فلز</h2>
<p>خمکاری یکی از فرآیندهای مهم در ساخت ورق فلز است که به روش‌های مختلف انجام می‌شود.</p>

<h2>روش‌های خمکاری</h2>
<ul>
  <li>خمکاری با پرس بریک</li>
  <li>خمکاری رول</li>
  <li>خمکاری با قالب</li>
</ul>

<h2>محاسبات</h2>
<p>برای خمکاری دقیق، باید به ضخامت ورق، شعاع خم و زاویه خم توجه کرد.</p>`,

  `<h2>جوشکاری TIG</h2>
<p>جوشکاری TIG (Tungsten Inert Gas) یکی از روش‌های دقیق جوشکاری است که کیفیت بالایی دارد.</p>

<h2>مزایا</h2>
<ul>
  <li>کیفیت جوش بالا</li>
  <li>کنترل دقیق حرارت</li>
  <li>قابلیت جوشکاری فلزات نازک</li>
</ul>

<h2>تکنیک‌ها</h2>
<p>برای جوشکاری موفق با TIG، باید به تنظیمات دستگاه، انتخاب الکترود و تکنیک جوشکاری توجه کرد.</p>`,

  `<h2>جوشکاری MIG/MAG</h2>
<p>جوشکاری MIG/MAG یکی از رایج‌ترین روش‌های جوشکاری است که سرعت و کارایی بالایی دارد.</p>

<h2>تفاوت MIG و MAG</h2>
<p>در MIG از گاز خنثی و در MAG از گاز فعال استفاده می‌شود.</p>

<h2>کاربردها</h2>
<p>این روش در صنایع مختلف از جمله خودروسازی و ساخت و ساز کاربرد دارد.</p>`,

  `<h2>پرداخت سطح فلزات</h2>
<p>پرداخت سطح یکی از مراحل مهم در تولید است که کیفیت نهایی محصول را تعیین می‌کند.</p>

<h2>روش‌های پرداخت</h2>
<ul>
  <li>پولیش مکانیکی</li>
  <li>پولیش شیمیایی</li>
  <li>سندبلاست</li>
  <li>آندایزینگ</li>
</ul>

<h2>انتخاب روش مناسب</h2>
<p>انتخاب روش پرداخت به جنس فلز، کاربرد محصول و بودجه بستگی دارد.</p>`,

  `<h2>آندایزینگ آلومینیوم</h2>
<p>آندایزینگ فرآیندی است که لایه محافظتی روی سطح آلومینیوم ایجاد می‌کند.</p>

<h2>مراحل آندایزینگ</h2>
<ol>
  <li>تمیزکاری</li>
  <li>آندایزینگ</li>
  <li>رنگ‌آمیزی (اختیاری)</li>
  <li>سیل کردن</li>
</ol>

<h2>مزایا</h2>
<p>آندایزینگ مقاومت به خوردگی و سایش را افزایش می‌دهد.</p>`,

  `<h2>چاپ سه‌بعدی فلزات</h2>
<p>چاپ سه‌بعدی فلزات یکی از تکنولوژی‌های نوین در تولید است.</p>

<h2>روش‌ها</h2>
<ul>
  <li>SLM (Selective Laser Melting)</li>
  <li>EBM (Electron Beam Melting)</li>
  <li>DED (Direct Energy Deposition)</li>
</ul>

<h2>مزایا</h2>
<p>این روش امکان تولید قطعات پیچیده با حداقل ضایعات را فراهم می‌کند.</p>`,

  `<h2>قالب‌سازی تزریقی</h2>
<p>قالب‌سازی تزریقی روشی برای تولید انبوه قطعات پلاستیکی است.</p>

<h2>مراحل تولید</h2>
<ol>
  <li>طراحی قالب</li>
  <li>ساخت قالب</li>
  <li>تزریق مواد</li>
  <li>خنک‌سازی و جداسازی</li>
</ol>

<h2>نکات مهم</h2>
<p>طراحی قالب و انتخاب مواد مناسب از عوامل کلیدی در موفقیت این فرآیند است.</p>`,

  `<h2>ریخته‌گری</h2>
<p>ریخته‌گری یکی از قدیمی‌ترین روش‌های تولید است که هنوز کاربرد دارد.</p>

<h2>انواع ریخته‌گری</h2>
<ul>
  <li>ریخته‌گری در ماسه</li>
  <li>ریخته‌گری تحت فشار</li>
  <li>ریخته‌گری دقیق</li>
</ul>

<h2>کاربردها</h2>
<p>ریخته‌گری برای تولید قطعات بزرگ و پیچیده استفاده می‌شود.</p>`,

  `<h2>پولیش و پرداخت سطح</h2>
<p>پولیش فرآیندی است که سطح را صاف و براق می‌کند.</p>

<h2>مراحل پولیش</h2>
<ol>
  <li>سنباده‌زنی</li>
  <li>پولیش خشن</li>
  <li>پولیش نهایی</li>
</ol>

<h2>ابزارها</h2>
<p>استفاده از ابزار و مواد مناسب برای دستیابی به نتیجه مطلوب ضروری است.</p>`,

  `<h2>سنگ‌زنی</h2>
<p>سنگ‌زنی یکی از روش‌های پرداخت نهایی است که دقت بالایی دارد.</p>

<h2>انتخاب چرخ سنگ</h2>
<p>انتخاب چرخ سنگ مناسب به جنس قطعه کار و عملیات مورد نظر بستگی دارد.</p>

<h2>پارامترها</h2>
<ul>
  <li>سرعت چرخ</li>
  <li>سرعت قطعه کار</li>
  <li>عمق برش</li>
</ul>`,

  `<h2>ماشینکاری با دقت بالا</h2>
<p>ماشینکاری با دقت بالا برای تولید قطعات با تلرانس‌های بسیار کم استفاده می‌شود.</p>

<h2>تکنیک‌ها</h2>
<ul>
  <li>استفاده از ماشین‌های دقیق</li>
  <li>کنترل دما</li>
  <li>برنامه‌نویسی دقیق</li>
</ul>

<h2>کاربردها</h2>
<p>این روش در صنایع هوافضا، پزشکی و الکترونیک کاربرد دارد.</p>`,

  `<h2>کنترل کیفیت در تولید</h2>
<p>کنترل کیفیت یکی از مهم‌ترین بخش‌های فرآیند تولید است.</p>

<h2>روش‌های بازرسی</h2>
<ul>
  <li>بازرسی بصری</li>
  <li>اندازه‌گیری ابعادی</li>
  <li>تست‌های غیرمخرب</li>
</ul>

<h2>اهمیت</h2>
<p>کنترل کیفیت مناسب باعث کاهش ضایعات و افزایش رضایت مشتری می‌شود.</p>`,

  `<h2>بهینه‌سازی فرآیند تولید</h2>
<p>بهینه‌سازی فرآیند تولید برای کاهش هزینه‌ها و افزایش کارایی ضروری است.</p>

<h2>روش‌ها</h2>
<ul>
  <li>تحلیل فرآیند</li>
  <li>شناسایی گلوگاه‌ها</li>
  <li>بهبود مستمر</li>
</ul>

<h2>نتیجه</h2>
<p>بهینه‌سازی مناسب باعث کاهش ضایعات و افزایش سودآوری می‌شود.</p>`,

  `<h2>نگهداری و تعمیرات ماشین‌آلات</h2>
<p>نگهداری منظم ماشین‌آلات برای افزایش عمر مفید و کاهش خرابی ضروری است.</p>

<h2>برنامه نگهداری</h2>
<ul>
  <li>نگهداری پیشگیرانه</li>
  <li>بازرسی منظم</li>
  <li>تعمیرات به موقع</li>
</ul>

<h2>مزایا</h2>
<p>نگهداری مناسب باعث کاهش هزینه‌ها و افزایش کارایی می‌شود.</p>`,

  `<h2>انتخاب متریال مناسب</h2>
<p>انتخاب متریال مناسب یکی از مهم‌ترین تصمیم‌ها در تولید است.</p>

<h2>عوامل موثر</h2>
<ul>
  <li>کاربرد محصول</li>
  <li>شرایط محیطی</li>
  <li>بودجه</li>
  <li>قابلیت تولید</li>
</ul>

<h2>راهنمای انتخاب</h2>
<p>برای انتخاب مناسب، باید به خواص مکانیکی، شیمیایی و فیزیکی مواد توجه کرد.</p>`,
];

export async function seedEducationalArticles(dataSource: DataSource) {
  const articleRepository = dataSource.getRepository(EducationalArticle);
  const categoryRepository = dataSource.getRepository(Category);
  const userRepository = dataSource.getRepository(User);

  console.log('شروع ایجاد مقالات آموزشی...\n');

  // Get categories
  const categories = await categoryRepository.find({
    where: { parentId: IsNull() },
    take: 5,
  });

  if (categories.length === 0) {
    console.log('⚠️ هیچ دسته‌بندی یافت نشد. لطفا ابتدا دسته‌بندی‌ها را ایجاد کنید.');
    return;
  }

  // Get admin user as author
  const adminUser = await userRepository.findOne({
    where: { role: UserRole.ADMIN },
  });

  if (!adminUser) {
    console.log('⚠️ کاربر ادمین یافت نشد. لطفا ابتدا کاربر ادمین را ایجاد کنید.');
    return;
  }

  let articleCount = 0;

  for (let i = 0; i < articleTitles.length; i++) {
    try {
      const title = articleTitles[i];
      const slug = await generateUniqueSlug(articleRepository, generateSlug(title));
      const category = categories[i % categories.length];
      const content = articleContents[i] || `<p>محتوای کامل مقاله ${title}.</p>`;
      const excerpt = `خلاصه مقاله ${title}. این مقاله شامل اطلاعات مفیدی در مورد موضوع مورد نظر است.`;

      const article = articleRepository.create({
        title,
        slug,
        excerpt,
        content,
        featuredImage: `/uploads/articles/article-${i + 1}.jpg`,
        categoryId: category?.id || null,
        authorId: adminUser.id,
        metaTitle: title,
        metaDescription: `مقاله آموزشی جامع در مورد ${title}. شامل راهنمای کامل، تکنیک‌ها و نکات کاربردی.`,
        isPublished: true,
        publishedAt: new Date(Date.now() - i * 24 * 60 * 60 * 1000), // Stagger dates
        viewCount: Math.floor(Math.random() * 1000) + 50,
      });

      await articleRepository.save(article);
      articleCount++;
      console.log(`✓ مقاله ${i + 1}: ${title}`);
    } catch (error: any) {
      console.log(`✗ خطا در ایجاد مقاله ${i + 1}: ${error.message}`);
    }
  }

  console.log(`\n✓ ${articleCount} مقاله آموزشی با موفقیت ایجاد شد.`);
}

